<!DOCTYPE html> 
<html lang="id"> 
<head> 
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title>Sistem Inventaris SDN JATIASIH I</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module"> 
// Konfigurasi Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";

// Menggunakan nama fungsi standar Firebase (English)
import { 
    getAuth, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs, 
    getDoc, 
    doc, 
    updateDoc, 
    deleteDoc, 
    query, 
    where, 
    orderBy
} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

import { 
    getStorage, 
    ref, 
    uploadBytes, 
    getDownloadURL 
} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

const firebaseConfig = {
¬† apiKey: "AIzaSyAkVZlF1T3EYiUQxeUnEiew2uXanuQcFJ8",
¬† authDomain: "inventaris-sekolah-6aa45.firebaseapp.com",
¬† projectId: "inventaris-sekolah-6aa45",
¬† // Perbaikan: Gunakan format .appspot.com untuk Storage Bucket
¬† storageBucket: "inventaris-sekolah-6aa45.appspot.com", 
¬† messagingSenderId: "482992763821",
¬† appId: "1:482992763821:web:baea4937e2cfd37b0c2724",
¬† measurementId: "G-107GNWQBJY"
};

const aplikasi = initializeApp(firebaseConfig);
const auth = getAuth(aplikasi);
const db = getFirestore(aplikasi);
const penyimpanan = getStorage(aplikasi);

// Jadikan Firebase tersedia secara global
window.firebaseAuth = auth;
window.firebaseDb = db;
// KODE BARU DI <script type="module">
window.firebaseStorage = penyimpanan;
window.firebaseUtils = {
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged, 
    collection, 
    addDoc, 
    getDocs,
	getDoc,
    doc, 
    updateDoc, 
    deleteDoc, 
    query, 
    where, 
    orderBy, 
    ref, 
    uploadBytes, 
    getDownloadURL,
    // Tambahkan variabel 'auth' dan 'db' agar dapat diakses oleh fungsi di luar module script
    auth: auth, 
    db: db
};
// Catatan: Variabel window.firebaseAuth dan window.firebaseDb sudah Anda definisikan di atasnya,
// jadi penambahan ini bersifat opsional, tetapi memastikan semua properti penting ada di dalam object utils.

// --- SCRIPT LAINNYA DI SINI --- (Pastikan skrip lain menggunakan nama fungsi yang sudah di-expose di window.firebaseUtils atau variabel auth/db/penyimpanan)
// ... (Bagian script sisanya dari file Anda)

</script> 
<style>
 body { 
box-sizing: border-box; 
} @media print { .no-print { display: none !important; } .print-only { display: block !important; } body { font-size: 12px; } } .print-only { display: none; } 
</style> 
</head> 
<body class="bg-gray-50 font-sans">
<div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-blue-800"> 
<div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md"> 
<div class="text-center mb-8"> <h1 class="text-2xl font-bold text-gray-800 mb-2">Sistem Inventaris</h1> <p class="text-gray-600">SDN JATIASIH I</p> 
</div> 
<div id="loginFormContainer"> 
    <form id="loginForm" class="space-y-6"> 
       <div> 
            <label class="block text-sm font-medium text-gray-700 mb-2">Surel</label> 
            <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="" required> 
        </div> 
        <div> 
            <label class="block text-sm font-medium text-gray-700 mb-2">Kata Sandi</label> 
            <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="" required> 
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium"> Masuk </button> 
    </form> 
    <div class="mt-4 text-center"> 
        <button onclick="showRegisterForm()" class="text-blue-600 hover:text-blue-800 text-sm"> Belum punya akun? Daftar di sini </button> 
    </div> 
</div> 
<div id="registerFormContainer" class="hidden"> 
    <form id="registerForm" class="space-y-4"> 
        <div> 
            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label> 
            <input type="text" id="registerNama" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
        </div> 
        <div> 
            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label> 
            <input type="email" id="registerEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
        </div> 
        <div> 
    <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon</label> 
    <input type="tel" id="registerTelepon" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
</div>
        <div> 
            <label class="block text-sm font-medium text-gray-700 mb-2">Jabatan</label> 
            <input type="text" id="registerJabatan" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
        </div> 
        <div> 
            <label class="block text-sm font-medium text-gray-700 mb-2">Kata Sandi</label> 
            <input type="password" id="registerPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
        </div> 
        <div> 
            <label class="block text-sm font-medium text-gray-700 mb-2">Konfirmasi Kata Sandi</label> 
            <input type="password" id="registerConfirmPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
        </div> 
        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 font-medium"> Daftar Akun </button> 
    </form> 
    <div class="mt-4 text-center"> 
        <button onclick="showLoginForm()" class="text-blue-600 hover:text-blue-800 text-sm"> Sudah punya akun? Masuk di sini </button> 
    </div> 
</div> 
<div id="loginError" class="mt-4 text-red-600 text-sm text-center hidden"> </div> 
<div id="registerSuccess" class="mt-4 text-green-600 text-sm text-center hidden"> </div> 
</div> 
</div> 
<div id="mainApp" class="hidden"> 
<header class="bg-white shadow-sm border-b"> 
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"> 
<div class="flex justify-between items-center py-4"> 
<div> 
<h1 class="text-2xl font-bold text-gray-900">Sistem Inventaris</h1> 
<p class="text-sm text-gray-600">SDN JATIASIH I - Dinas Pendidikan Kota Bekasi</p> 
</div> 
<button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200"> Keluar </button> 
</div> 
</div> 
</header> 
<nav class="bg-blue-600 text-white"> 
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"> 
<div class="flex space-x-8 overflow-x-auto"> 
<button onclick="showSection('dashboard')" class="nav-btn py-4 px-6 hover:bg-blue-700 transition duration-200 whitespace-nowrap">Dasbor</button> 
<button onclick="showSection('gedung')" class="nav-btn py-4 px-6 hover:bg-blue-700 transition duration-200 whitespace-nowrap">Data Gedung</button> 
<button onclick="showSection('ruangan')" class="nav-btn py-4 px-6 hover:bg-blue-700 transition duration-200 whitespace-nowrap">Data Ruangan</button> 
<button onclick="showSection('barang')" class="nav-btn py-4 px-6 hover:bg-blue-700 transition duration-200 whitespace-nowrap">Data Barang</button> 
<button onclick="showSection('laporan')" class="nav-btn py-4 px-6 hover:bg-blue-700 transition duration-200 whitespace-nowrap">Laporan</button> 
<button onclick="showSection('admin')" class="nav-btn py-4 px-6 hover:bg-blue-700 transition duration-200 whitespace-nowrap" id="adminMenu" style="display:none;">Admin</button> 
</div> 
</div> 
</nav> 
<div id="dasbor" class="section max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"> 
<h2 class="text-3xl font-bold text-gray-900 mb-8">Dasbor</h2> 
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"> 
<div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500"> 
<div class="flex items-center"> 
<div class="flex-1"> 
<p class="text-sm font-medium text-gray-600">Total Barang</p> 
<p id="totalBarang" class="text-2xl font-bold text-gray-900">0</p> 
</div> 
<div class="text-blue-500 text-3xl">üì¶</div> 
</div> 
</div> 
<div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500"> 
<div class="flex items-center"> 
<div class="flex-1"> 
<p class="text-sm font-medium text-gray-600">Total Gedung</p> 
<p id="totalGedung" class="text-2xl font-bold text-gray-900">0</p> 
</div> 
<div class="text-green-500 text-3xl">üè¢</div> 
</div> 
</div> 
<div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500"> 
<div class="flex items-center"> 
<div class="flex-1"> 
<p class="text-sm font-medium text-gray-600">Total Ruangan</p> 
<p id="totalRuangan" class="text-2xl font-bold text-gray-900">0</p> 
</div> 
<div class="text-yellow-500 text-3xl">üè†</div> 
</div> 
</div> 
<div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500"> 
<div class="flex items-center"> 
<div class="flex-1"> 
<p class="text-sm font-medium text-gray-600">Penanggung Jawab</p> 
<p id="totalPenanggungJawab" class="text-2xl font-bold text-gray-900">0</p> 
</div> 
<div class="text-purple-500 text-3xl">üë•</div> 
</div> 
</div> 
</div> 
<div class="bg-white p-6 rounded-xl shadow-lg"> 
<h3 class="text-xl font-bold text-gray-900 mb-4">Kondisi Barang</h3> 
<div class="grid grid-cols-1 md:grid-cols-3 gap-4"> 
<div class="text-center p-4 bg-green-50 rounded-lg"> 
<div class="text-2xl font-bold text-green-600" id="kondisiB">0</div> 
<div class="text-sm text-gray-600">Baik (B)</div> 
</div> 
<div class="text-center p-4 bg-yellow-50 rounded-lg"> 
<div class="text-2xl font-bold text-yellow-600" id="kondisiRR">0</div> 
<div class="text-sm text-gray-600">Rusa Ringan (RR)</div> 
</div> 
<div class="text-center p-4 bg-red-50 rounded-lg"> 
<div class="text-2xl font-bold text-red-600" id="kondisiRB">0</div> 
<div class="text-sm text-gray-600">Rusa Berat (RB)</div> 
</div> 
</div> 
</div> 
</div> 
<div id="barang" class="section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"> 
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"> 
<h2 class="text-3xl font-bold text-gray-900">Data Barang</h2> 
<button onclick="showBarangForm()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium"> ‚ûï Tambah Barang </button> 
</div> 
<div class="mb-6"> 
<input type="text" id="searchBarang" placeholder="Cari barang..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> 
</div> 
<div class="bg-white rounded-xl shadow-lg overflow-hidden"> 
<div class="overflow-x-auto"> 
<table class="min-w-full divide-y divide-gray-200"> 
<thead class="bg-gray-50"> <tr> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Merk</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tahun</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kondisi</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ruangan</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th> 
</tr> 
</thead> 
<tbody id="barangTableBody" class="bg-white divide-y divide-gray-200"> 
</tbody> 
</table> 
</div> 
</div> 
</div> 
<div id="gedung" class="section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"> 
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"> 
<h2 class="text-3xl font-bold text-gray-900">Data Gedung</h2> 
<button onclick="showGedungForm()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium"> ‚ûï Tambah Gedung </button> 
</div> 
<div class="bg-white rounded-xl shadow-lg overflow-hidden"> 
<div class="overflow-x-auto"> <table class="min-w-full divide-y divide-gray-200"> 
<thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Gedung</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Luas</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah Lantai</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tahun Bangun</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sumber Anggaran</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th> 
</tr> 
</thead> 
<tbody id="gedungTableBody" class="bg-white divide-y divide-gray-200"> 
</tbody> 
</table> 
</div> 
</div> 
</div> 
<div id="ruangan" class="section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"> 
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"> 
<h2 class="text-3xl font-bold text-gray-900">Data Ruangan</h2> 
<button onclick="showRuanganForm()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium"> ‚ûï Tambah Ruangan </button> 
</div> 
<div class="bg-white rounded-xl shadow-lg overflow-hidden"> 
<div class="overflow-x-auto"> 
<table class="min-w-full divide-y divide-gray-200"> 
<thead class="bg-gray-50"> 
<tr> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gedung</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Ruangan</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Wali Kelas</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIP</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th> 
</tr> 
</thead> 
<tbody id="ruanganTableBody" class="bg-white divide-y divide-gray-200"> 
</tbody> 
</table> 
</div> 
</div> 
</div> 
<div id="penanggung-jawab" class="section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"> 
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"> 
<h2 class="text-3xl font-bold text-gray-900">Penanggung Jawab Ruangan</h2> 
<button onclick="showPenanggungJawabForm()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium"> ‚ûï Tambah Penanggung Jawab </button> 
</div> 
<div class="bg-white rounded-xl shadow-lg overflow-hidden"> 
<div class="overflow-x-auto"> 
<table class="min-w-full divide-y divide-gray-200"> 
<thead class="bg-gray-50"> 
<tr> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIP</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ruangan</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th> 
</tr> 
</thead> 
<tbody id="penanggungJawabTableBody" class="bg-white divide-y divide-gray-200"> 
</tbody> 
</table> 
</div> 
</div> 
</div> 
<div id="admin" class="section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"> 
<h2 class="text-3xl font-bold text-gray-900 mb-8">Panel Admin</h2> 
<div class="bg-white p-6 rounded-xl shadow-lg mb-6"> 
<h3 class="text-xl font-bold text-gray-900 mb-4">Unggah Logo Sekolah</h3> 
<div class="grid grid-cols-1 md:grid-cols-2 gap-6"> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Unggah Logo Baru</label> 
<input type="file" id="logoUpload" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> 
<button onclick="uploadLogo()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"> Simpan Logo </button> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Pratinjau Logo Saat Ini</label> 
<div id="logoPreview" class="w-32 h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center"> 
<span class="text-gray-500 text-4xl">üè´</span> 
</div> 
</div> 
</div> 
</div> 
<div class="bg-white p-6 rounded-xl shadow-lg"> 
<h3 class="text-xl font-bold text-gray-900 mb-4">Permohonan Registrasi Akun</h3> 
<div class="overflow-x-auto"> 
<table class="min-w-full divide-y divide-gray-200"> 
<thead class="bg-gray-50"> 
<tr> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telepon</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> 
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th> 
</tr> 
</thead> 
<tbody id="pendingRegistrationsTable" class="bg-white divide-y divide-gray-200"> 
</tbody> 
</table> 
</div> 
</div> 
</div> 
<div id="laporan" class="section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"> 
<h2 class="text-3xl font-bold text-gray-900 mb-6">Laporan Inventaris</h2> 
<div class="bg-white p-6 rounded-xl shadow-lg mb-6"> 
<h3 class="text-xl font-bold text-gray-900 mb-4">Filter Laporan</h3> 
<div class="grid grid-cols-1 md:grid-cols-3 gap-4"> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Pilih Ruangan</label> 
<select id="filterRuangan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> 
<option value="">Semua Ruangan</option> 
</select> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Kondisi</label> 
<select id="filterKondisi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> 
<option value="">Semua Kondisi</option> 
<option value="B">Baik (B)</option> 
<option value="RR">Kerangka Ringan (RR)</option> 
<option value="RB">Kerangka Berat (RB)</option> 
</select> 
</div> 
<div class="flex items-end"> 
<button onclick="generateLaporan()" class="w-full bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200 font-medium"> üñ®Ô∏è Generate Laporan </button> 
</div> 
</div> 
</div> 
<div id="laporanPreview" class="bg-white rounded-xl shadow-lg overflow-hidden hidden"> 
<div class="p-6 no-print"> 
<div class="flex justify-between items-center mb-4"> 
<h3 class="text-xl font-bold text-gray-900">Pratinjau Laporan</h3> 
<div class="space-x-2"> 
<button onclick="printLaporan()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"> üñ®Ô∏è Cetak </button> 
<button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200"> üìä Ekspor Excel </button> 
</div> 
</div> 
</div> 
<div id="laporanContent">
</div> 
</div> 
</div> 
</div> 
<div id="barangModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"> 
<div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-screen overflow-y-auto"> 
<div class="p-6"> 
<div class="flex justify-between items-center mb-6"> 
<h3 id="barangModalTitle" class="text-2xl font-bold text-gray-900">Tambah Barang</h3> 
<button onclick="closeBarangModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button> 
</div> 
<form id="barangForm" class="space-y-4"> 
<input type="hidden" id="barangId"> 
<div class="grid grid-cols-1 md:grid-cols-2 gap-4"> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Kode Barang</label> 
<div class="flex"> 
<input type="text" id="kodeBarang" class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" readonly> 
<button type="button" onclick="generateKodeBarang()" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700 transition duration-200"> üîÑ </button> 
</div> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Nama Barang *</label> 
<input type="text" id="namaBarang" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Merk</label> 
<input type="text" id="merkBarang" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Tahun Perolehan *</label> 
<input type="number" id="tahunPerolehan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" min="1900" max="2030" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Penguasaan *</label> 
<select id="penguasaan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
<option value="">Pilihan Penguasaan</option> 
<option value="Milik sendiri">Milik sendiri</option> 
<option value="Hibah">Hibah</option> 
<option value="Milik pegawai">Milik pegawai</option> 
<option value="Lainnya">Lainnya</option> 
</select> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Jumlah *</label> 
<input type="number" id="jumlahBarang" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" min="1" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Satuan *</label> 
<select id="satuanBarang" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
<option value="">Pilih Satuan</option> 
<option value="Unit">Unit</option> 
<option value="Set">Set</option> 
<option value="Pcs">Pcs</option> 
<option value="Buah">Buah</option> 
</select> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Lokasi Barang (Ruangan) *</label> 
<select id="LokasiBarang" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
<option value="">Pilih Ruangan</option> 
</select> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Kondisi *</label> 
<select id="kondisiBarang" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
<option value="">Pilih Kondisi</option> 
<option value="B">Baik (B)</option> 
<option value="RR">Rusak Ringan (RR)</option> 
<option value="RB">Rusak Berat (RB)</option> 
</select> 
</div> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Foto Barang</label> 
<input type="file" id="photoBarang" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> 
<div id="photoPreview" class="mt-2 hidden"> 
<img id="previewImage" class="w-32 h-32 object-cover rounded-lg border"> 
</div> 
</div> 
<div class="flex justify-end space-x-4 pt-4"> 
<button type="button" onclick="closeBarangModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200"> Batal </button> 
<button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200"> Simpan </button> 
</div> 
</form> 
</div> 
</div> 
</div> 
<div id="gedungModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"> 
<div class="bg-white rounded-xl shadow-2xl w-full max-w-lg"> 
<div class="p-6"> 
<div class="flex justify-between items-center mb-6"> 
<h3 id="gedungModalTitle" class="text-2xl font-bold text-gray-900">Tambah Gedung</h3> 
<button onclick="closeGedungModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button> 
</div> 
<form id="gedungForm" class="space-y-4"> 
<input type="hidden" id="gedungId"> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">No. *</label> 
<input type="text" id="noGedung" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Nama Gedung *</label> 
<input type="text" id="namaGedung" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Luas Gedung (m¬≤) *</label> 
<input type="number" id="luasGedung" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" min="1" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Lantai *</label> 
<input type="number" id="jumlahLantai" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" min="1" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Tahun Bangun *</label> 
<input type="number" id="tahunBangun" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" min="1900" max="2030" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Sumber Anggaran</label> 
<input type="text" id="sumberAnggaran" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> 
</div> 
<div class="flex justify-end space-x-4 pt-4"> 
<button type="button" onclick="closeGedungModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200"> Batal </button> 
<button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200"> Simpan </button> 
</div> 
</form> 
</div> 
</div> 
</div> 
<div id="ruanganModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"> 
<div class="bg-white rounded-xl shadow-2xl w-full max-w-lg"> 
<div class="p-6"> 
<div class="flex justify-between items-center mb-6"> 
<h3 id="ruanganModalTitle" class="text-2xl font-bold text-gray-900">Tambah Ruangan</h3> 
<button onclick="closeRuanganModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button> 
</div> 
<form id="ruanganForm" class="space-y-4"> 
<input type="hidden" id="ruanganId"> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Pilih Gedung *</label> 
<select id="ruanganGedungId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
<option value="">Pilih Gedung</option> 
</select> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Nama Ruangan *</label> 
<input type="text" id="namaRuangan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Wali Kelas / Penanggung Jawab *</label> 
<input type="text" id="waliKelas" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">NIP Wali Kelas</label> 
<input type="text" id="nipWaliKelas" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> 
</div> 
<div class="flex justify-end space-x-4 pt-4"> 
<button type="button" onclick="closeRuanganModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200"> Batal </button> 
<button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200"> Simpan </button> 
</div> 
</form> 
</div> 
</div> 
</div> 
<div id="penanggungJawabModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"> 
<div class="bg-white rounded-xl shadow-2xl w-full max-w-lg"> 
<div class="p-6"> 
<div class="flex justify-between items-center mb-6"> 
<h3 id="penanggungJawabModalTitle" class="text-2xl font-bold text-gray-900">Tambah Penanggung Jawab</h3> 
<button onclick="closePenanggungJawabModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button> 
</div> 
<form id="penanggungJawabForm" class="space-y-4"> 
<input type="hidden" id="pjId"> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label> 
<input type="text" id="pjNama" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">NIP *</label> 
<input type="text" id="pjNip" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
</div> 
<div> 
<label class="block text-sm font-medium text-gray-700 mb-2">Ruangan yang Dipegang *</label> 
<select id="pjRuanganId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> 
<option value="">Pilih Ruangan</option> 
</select> 
</div> 
<div class="flex justify-end space-x-4 pt-4"> 
<button type="button" onclick="closePenanggungJawabModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200"> Batal </button> 
<button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200"> Simpan </button> 
</div> 
</form> 
</div> 
</div> 
</div>
<script>
// ====================================================================================
// FUNGSI INTI (di luar DOMContentLoaded)
// ====================================================================================

// FUNGSI UTAMA UNTUK NAVIGASI MENU
function showSection(sectionId) {
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => {
        section.classList.add('hidden');
    });

    const activeSection = document.getElementById(sectionId);
    if (activeSection) {
        activeSection.classList.remove('hidden');
    }
    
    // Panggil pemuatan data yang spesifik saat berpindah section (di sini loadBarangData yang menjadi masalah)
    if (sectionId === 'barang') {
        loadBarangData();
        // TODO: loadGedungOptions dan loadRuanganOptions jika diperlukan
    }
}

// Fungsi untuk memeriksa dan menampilkan menu Admin
function checkAdminMenu(role) {
    const adminMenu = document.getElementById('adminMenu');
    if (adminMenu) {
        adminMenu.style.display = (role === 'admin') ? 'block' : 'none';
    }
}

// FUNGSI LOGOUT GLOBAL
window.logout = async function() {
    try {
        await window.firebaseUtils.signOut(window.firebaseAuth);
    } catch (error) {
        console.error("Kesalahan saat keluar:", error);
    }
}

// ------------------------------------
// FUNGSI PEMUATAN DATA (Placeholder untuk Fix Logout)
// ------------------------------------

function loadBarangData() {
    // Fungsi placeholder agar tidak ReferenceError setelah menyimpan
    console.log("Fungsi loadBarangData dipanggil (memuat ulang tabel barang)...");
    // TODO: Isi logika untuk membaca data 'barang' dari Firestore dan merender ke 'barangTableBody'
}

function loadUserDataAndInitialize(user) {
    // Fungsi ini dipanggil setelah login/refresh untuk memuat data role user
    window.firebaseUtils.getDoc(
        window.firebaseUtils.doc(window.firebaseDb, "users", user.uid)
    ).then(userDoc => {
        const role = userDoc.exists() ? userDoc.data().role : 'user';
        
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        showSection('dasbor');
        checkAdminMenu(role);
        
        loadBarangData(); // Panggil data awal di sini
    }).catch(error => {
        console.error("Gagal memuat data pengguna:", error);
        // Biarkan onAuthStateChanged menangani kegagalan autentikasi
    });
}

// --- FUNGSI PENGONTROL MODAL BARANG & GEDUNG (Dibuat sederhana) ---

function closeBarangModal() {
    document.getElementById('barangModal').classList.add('hidden');
    document.getElementById('barangModal').classList.remove('flex');
    document.getElementById('photoPreview').classList.add('hidden');
}
function closeGedungModal() {
    document.getElementById('gedungModal').classList.add('hidden');
    document.getElementById('gedungModal').classList.remove('flex');
}
function closeRuanganModal() {
    document.getElementById('ruanganModal').classList.add('hidden');
    document.getElementById('ruanganModal').classList.remove('flex');
}
function closePenanggungJawabModal() {
    document.getElementById('penanggungJawabModal').classList.add('hidden');
    document.getElementById('penanggungJawabModal').classList.remove('flex');
}
function showBarangForm(barang = null) {
    const modal = document.getElementById('barangModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.getElementById('barangForm').reset();
    document.getElementById('barangId').value = '';
    document.getElementById('barangModalTitle').textContent = barang ? '‚úèÔ∏è Edit Barang' : '‚ûï Tambah Barang';
    document.getElementById('photoBarang').required = !barang;
}
function showGedungForm(gedung = null) {
    const modal = document.getElementById('gedungModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.getElementById('gedungForm').reset();
    document.getElementById('gedungId').value = '';
    document.getElementById('gedungModalTitle').textContent = '‚ûï Tambah Gedung';
}
function showRuanganForm() {
    document.getElementById('ruanganModal').classList.remove('hidden');
    document.getElementById('ruanganModal').classList.add('flex');
}
function showPenanggungJawabForm() {
    document.getElementById('penanggungJawabModal').classList.remove('hidden');
    document.getElementById('penanggungJawabModal').classList.add('flex');
}


// ====================================================================================
// AUTENTIKASI LISTENER GLOBAL (FIX LOGOUT UTAMA)
// ====================================================================================
// Ini harus dijalankan segera setelah skrip dimuat
window.firebaseUtils.onAuthStateChanged(window.firebaseAuth, (user) => {
    if (user) {
        // User signed in
        loadUserDataAndInitialize(user);
    } else {
        // User signed out
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
    }
});


// ====================================================================================
// EVENT LISTENER FORM (Dimuat setelah DOM siap untuk FIX SyntaxError)
// ====================================================================================
document.addEventListener('DOMContentLoaded', function() {

    // LOGIN FORM
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const errorDisplay = document.getElementById('loginError');
        errorDisplay.classList.add('hidden');

        try {
            // Karena sudah ada onAuthStateChanged, kita cukup login, onAuthStateChanged akan handle transisi screen.
            await window.firebaseUtils.signInWithEmailAndPassword(
                window.firebaseAuth, email, password
            );

        } catch (error) {
            console.error("Login Error:", error.code, error.message);
            let errorMessage = "Terjadi kesalahan saat masuk. Coba lagi.";
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                errorMessage = "Surel atau Kata Sandi salah.";
            } else if (error.code === 'auth/too-many-requests') {
                errorMessage = "Terlalu banyak percobaan. Coba lagi nanti.";
            }
            errorDisplay.textContent = errorMessage;
            errorDisplay.classList.remove('hidden');
        }
    });

    // BARANG FORM (Diperbaiki agar datanya lengkap)
    document.getElementById('barangForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const barangId = document.getElementById('barangId').value;
        const namaBarang = document.getElementById('namaBarang').value;
        const kodeBarang = document.getElementById('kodeBarang').value;
        const merkBarang = document.getElementById('merkBarang').value;
        const tahunPerolehan = document.getElementById('tahunPerolehan').value;
        const penguasaan = document.getElementById('penguasaan').value;
        const jumlahBarang = document.getElementById('jumlahBarang').value;
        const satuanBarang = document.getElementById('satuanBarang').value;
        const lokasiId = document.getElementById('LokasiBarang').value;
        const kondisiBarang = document.getElementById('kondisiBarang').value;
        const photoFile = document.getElementById('photoBarang').files[0];
        let photoURL = '';

        try {
            // UPLOAD FOTO
            if (photoFile) {
                const storageRef = window.firebaseUtils.ref(window.firebaseStorage, `barang_photos/${kodeBarang}_${Date.now()}`);
                const snapshot = await window.firebaseUtils.uploadBytes(storageRef, photoFile);
                photoURL = await window.firebaseUtils.getDownloadURL(snapshot.ref);
            }
            
            // Persiapan Data
            const dataBarang = {
                kode: kodeBarang,
                nama: namaBarang,
                merk: merkBarang || '',
                tahunPerolehan: parseInt(tahunPerolehan),
                penguasaan: penguasaan,
                jumlah: parseInt(jumlahBarang),
                satuan: satuanBarang,
                lokasi: lokasiId,
                kondisi: kondisiBarang,
                ...(photoURL && { photoURL: photoURL }),
                updatedAt: new Date(),
                // Di sini Anda perlu tahu nilai createdAt lama jika mode edit.
                // Karena kita tidak memiliki implementasi load/edit, ini disederhanakan:
                createdAt: barangId ? new Date() : new Date() 
            };
            
            // SAVE TO FIRESTORE
            if (barangId) {
                await window.firebaseUtils.updateDoc(
                    window.firebaseUtils.doc(window.firebaseDb, "barang", barangId),
                    dataBarang
                );
                alert("Barang berhasil diperbarui!");
            } else {
                await window.firebaseUtils.addDoc(
                    window.firebaseUtils.collection(window.firebaseDb, "barang"),
                    dataBarang
                );
                alert("Barang baru berhasil ditambahkan!");
            }
            
            // Aksi setelah sukses
            closeBarangModal();
            loadBarangData(); // Panggil fungsi untuk me-refresh tabel
            
        } catch (error) {
            console.error("Gagal menyimpan barang:", error);
            alert("Gagal menyimpan data barang. Pastikan semua field terisi benar dan coba lagi. Cek console log.");
            // TIDAK ADA LOGIKA LOGOUT DI SINI
        }
    });

    // FUNGSI NAVIGASI LOGIN/REGISTER
    window.showRegisterForm = function() {
        document.getElementById('loginFormContainer').classList.add('hidden');
        document.getElementById('registerFormContainer').classList.remove('hidden');
        document.getElementById('loginError').classList.add('hidden');
    }

    window.showLoginForm = function() {
        document.getElementById('registerFormContainer').classList.add('hidden');
        document.getElementById('loginFormContainer').classList.remove('hidden');
        document.getElementById('registerSuccess').classList.add('hidden');
    }
    
    // TODO: Tambahkan event listener form lainnya (gedungForm, ruanganForm, registerForm, dll.) di sini
});

</script>
</body> 
</html>