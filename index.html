<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Aplikasi Login Firebase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 300px;
      text-align: center;
    }

    .card h2 { margin-bottom: 20px; }

    .card input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }

    .card button {
      width: 100%;
      padding: 10px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
    }

    .card button:hover { background: #2980b9; }

    #loginError, #registerError, #resetError {
      color: red;
      font-size: 13px;
      margin-top: 8px;
    }

    .link {
      color: #3498db;
      cursor: pointer;
      font-size: 14px;
      display: block;
      margin-top: 10px;
    }

    .hidden { display: none; }
  </style>
</head>
<body>

  <!-- Layar Login -->
  <div id="loginScreen" class="card">
    <h2>Login</h2>
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Masukkan Email" required>
      <input type="password" id="loginPassword" placeholder="Masukkan Kata Sandi" required>
      <button type="submit">Masuk</button>
      <p id="loginError"></p>
    </form>
    <span class="link" onclick="showRegister()">Belum punya akun? Daftar</span>
    <span class="link" onclick="showReset()">Lupa kata sandi?</span>
  </div>

  <!-- Layar Register -->
  <div id="registerScreen" class="card hidden">
    <h2>Daftar Akun</h2>
    <form id="registerForm">
      <input type="email" id="registerEmail" placeholder="Masukkan Email" required>
      <input type="password" id="registerPassword" placeholder="Buat Kata Sandi" required>
      <button type="submit">Daftar</button>
      <p id="registerError"></p>
    </form>
    <span class="link" onclick="showLogin()">Sudah punya akun? Login</span>
  </div>

  <!-- Layar Reset Password -->
  <div id="resetScreen" class="card hidden">
    <h2>Reset Password</h2>
    <form id="resetForm">
      <input type="email" id="resetEmail" placeholder="Masukkan Email" required>
      <button type="submit">Kirim Email Reset</button>
      <p id="resetError"></p>
    </form>
    <span class="link" onclick="showLogin()">Kembali ke Login</span>
  </div>

  <!-- Layar Utama -->
  <div id="mainApp" class="card hidden">
    <h2>Halo üëã</h2>
    <p>Anda berhasil login</p>
    <button id="logoutBtn">Keluar</button>
  </div>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    // üîë CONFIG FIREBASE (SUDAH TERPASANG)
    const firebaseConfig = {
      apiKey: "AIzaSyAkVZlF1T3EYiUQxeUnEiew2uXanuQcFJ8",
      authDomain: "inventaris-sekolah-6aa45.firebaseapp.com",
      projectId: "inventaris-sekolah-6aa45",
      storageBucket: "inventaris-sekolah-6aa45.firebasestorage.app",
      messagingSenderId: "482992763821",
      appId: "1:482992763821:web:3476cb5bd7320d840c2724",
      measurementId: "G-C51S4NNKXM"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);

    // Listener login global
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('registerScreen').classList.add('hidden');
        document.getElementById('resetScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
      } else {
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
      }
    });

    // Login form
    document.getElementById("loginForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const errorDisplay = document.getElementById("loginError");

      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(() => errorDisplay.textContent = "")
        .catch((err) => errorDisplay.textContent = "Login gagal: " + err.message);
    });

    // Register form
    document.getElementById("registerForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const email = document.getElementById("registerEmail").value;
      const password = document.getElementById("registerPassword").value;
      const errorDisplay = document.getElementById("registerError");

      firebase.auth().createUserWithEmailAndPassword(email, password)
        .then(() => {
          errorDisplay.textContent = "";
          alert("Akun berhasil dibuat! Silakan login.");
          showLogin();
        })
        .catch((err) => errorDisplay.textContent = "Gagal daftar: " + err.message);
    });

    // Reset password form
    document.getElementById("resetForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const email = document.getElementById("resetEmail").value;
      const errorDisplay = document.getElementById("resetError");

      firebase.auth().sendPasswordResetEmail(email)
        .then(() => {
          errorDisplay.style.color = "green";
          errorDisplay.textContent = "Email reset terkirim! Periksa kotak masuk Anda.";
        })
        .catch((err) => {
          errorDisplay.style.color = "red";
          errorDisplay.textContent = "Gagal: " + err.message;
        });
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", function() {
      firebase.auth().signOut();
    });

    // Fungsi navigasi layar
    function showRegister() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('registerScreen').classList.remove('hidden');
      document.getElementById('resetScreen').classList.add('hidden');
    }

    function showLogin() {
      document.getElementById('registerScreen').classList.add('hidden');
      document.getElementById('resetScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    function showReset() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('registerScreen').classList.add('hidden');
      document.getElementById('resetScreen').classList.remove('hidden');
    }
  </script>
<script src="script.js" defer></script>
</body>
</html>

// ====================================================================================
// FUNGSI GLOBAL & NAVIGASI
// ====================================================================================

function showSection(sectionId) {
    const sections = document.querySelectorAll('.section');
    sections.forEach(function(section) {
        section.classList.add('hidden');
    });

    const activeSection = document.getElementById(sectionId);
    if (activeSection) {
        activeSection.classList.remove('hidden');
    }
    
    if (sectionId === 'barang') {
        loadBarangData();
    }
}

function checkAdminMenu(role) {
    const adminMenu = document.getElementById('adminMenu');
    if (adminMenu) {
        adminMenu.style.display = (role === 'admin') ? 'block' : 'none';
    }
}

// FUNGSI LOGOUT GLOBAL (Menggunakan .then() untuk kompatibilitas)
window.logout = function() {
    window.firebaseUtils.signOut(window.firebaseAuth)
    .then(function() {
        console.log("Berhasil keluar.");
    })
    .catch(function(error) {
        console.error("Kesalahan saat keluar:", error);
    });
}

// ------------------------------------
// FUNGSI PEMUATAN DATA & INISIALISASI
// ------------------------------------

function loadBarangData() {
    console.log("Fungsi loadBarangData dipanggil...");
}

function loadUserDataAndInitialize(user) {
    // Perbaikan: Gunakan window.firebaseDb alih-alih window.firebaseUtils.db
    // meskipun keduanya menunjuk ke objek yang sama, penggunaan yang di-expose secara langsung lebih jelas.
    // Tapi jika Anda ingin konsisten, pakai window.firebaseUtils.doc(window.firebaseUtils.db, ...)
    window.firebaseUtils.getDoc(
        window.firebaseUtils.doc(window.firebaseDb, "users", user.uid) 
    ).then(function(userDoc) {
        const role = userDoc.exists() ? userDoc.data().role : 'user';
        
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        showSection('dasbor');
        checkAdminMenu(role);
        
        loadBarangData(); 
    }).catch(function(error) {
        console.error("Gagal memuat data pengguna:", error);
    });
}


// --- FUNGSI PENGONTROL MODAL ---

function closeBarangModal() {
    document.getElementById('barangModal').classList.add('hidden');
    document.getElementById('barangModal').classList.remove('flex');
    document.getElementById('photoPreview').classList.add('hidden');
}
function showBarangForm(barang) { // Hapus default null agar lebih aman
    const modal = document.getElementById('barangModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.getElementById('barangForm').reset();
    document.getElementById('barangId').value = '';
    document.getElementById('barangModalTitle').textContent = barang ? '‚úèÔ∏è Edit Barang' : '‚ûï Tambah Barang';
    document.getElementById('photoBarang').required = !barang;
    // Tambahkan log untuk memastikan modal dipanggil:
    console.log("Menampilkan formulir Barang. Mode:", barang ? 'Edit' : 'Tambah');
}
function closeGedungModal() {
    document.getElementById('gedungModal').classList.add('hidden');
    document.getElementById('gedungModal').classList.remove('flex');
}
function showGedungForm(gedung) { // Hapus default null
    const modal = document.getElementById('gedungModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.getElementById('gedungForm').reset();
    document.getElementById('gedungId').value = '';
    document.getElementById('gedungModalTitle').textContent = '‚ûï Tambah Gedung';
}
// Tambahkan fungsi modal ruangan, dll. di sini.


// ====================================================================================
// AUTENTIKASI LISTENER GLOBAL (BARIS 707 DENGAN PERBAIKAN SINTAKSIS MODULE)
// ====================================================================================

// Ini adalah kunci untuk menjaga sesi tetap hidup dan menangani transisi UI.
// Kesalahan di baris ini seharusnya teratasi setelah memperbaiki syntax error di atas.
window.firebaseUtils.onAuthStateChanged(window.firebaseAuth, function(user) {
    if (user) {
        loadUserDataAndInitialize(user);
    } else {
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
    }
});


// ====================================================================================
// EVENT LISTENER FORM 
// ====================================================================================
document.addEventListener('DOMContentLoaded', function() {

    // LOGIN FORM
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const errorDisplay = document.getElementById('loginError');
        errorDisplay.classList.add('hidden');

        window.firebaseUtils.signInWithEmailAndPassword(
            window.firebaseAuth, email, password
        )
        .then(function() {
            // Sukses ditangani oleh onAuthStateChanged
        })
        .catch(function(error) {
            console.error("Login Error:", error.code, error.message);
            let errorMessage = "Terjadi kesalahan saat masuk. Coba lagi.";
            
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                errorMessage = "Surel atau Kata Sandi salah.";
            } else if (error.code === 'auth/too-many-requests') {
                errorMessage = "Terlalu banyak percobaan. Coba lagi nanti.";
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = "Format Surel tidak valid.";
            }
            errorDisplay.textContent = errorMessage;
            errorDisplay.classList.remove('hidden');
        });
    });

    // BARANG FORM
    document.getElementById('barangForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const barangId = document.getElementById('barangId').value;
        const namaBarang = document.getElementById('namaBarang').value;
        const kodeBarang = document.getElementById('kodeBarang').value;
        const merkBarang = document.getElementById('merkBarang').value;
        const tahunPerolehan = document.getElementById('tahunPerolehan').value;
        const penguasaan = document.getElementById('penguasaan').value;
        const jumlahBarang = document.getElementById('jumlahBarang').value;
        const satuanBarang = document.getElementById('satuanBarang').value;
        const lokasiId = document.getElementById('LokasiBarang').value;
        const kondisiBarang = document.getElementById('kondisiBarang').value;
        const photoFile = document.getElementById('photoBarang').files[0];
        let photoURL = '';

        // Gunakan Promise chain untuk upload
        const uploadTask = new Promise(function(resolve, reject) {
            if (photoFile) {
                // Perbaikan: Pastikan penggunaan window.firebaseStorage
                const storageRef = window.firebaseUtils.ref(window.firebaseStorage, 'barang_photos/' + kodeBarang + '_' + Date.now());
                window.firebaseUtils.uploadBytes(storageRef, photoFile)
                .then(function(snapshot) {
                    return window.firebaseUtils.getDownloadURL(snapshot.ref);
                })
                .then(function(url) {
                    resolve(url);
                })
                .catch(function(error) {
                    reject(error);
                });
            } else {
                resolve('');
            }
        });

        uploadTask
        .then(function(url) {
            photoURL = url;
            
            // Persiapan Data
            const dataBarang = {
                kode: kodeBarang,
                nama: namaBarang,
                merk: merkBarang || '',
                tahunPerolehan: parseInt(tahunPerolehan),
                penguasaan: penguasaan,
                jumlah: parseInt(jumlahBarang),
                satuan: satuanBarang,
                lokasi: lokasiId,
                kondisi: kondisiBarang,
                updatedAt: new Date(),
                // Gunakan createdAt hanya saat menambahkan, atau jika edit, pastikan field ini ada
                createdAt: new Date() 
            };
            
            // Tambahkan photoURL secara kondisional
            if (photoURL) {
                dataBarang.photoURL = photoURL;
            }

            // SAVE TO FIRESTORE
            let saveDoc;
            if (barangId) {
                saveDoc = window.firebaseUtils.updateDoc(window.firebaseUtils.doc(window.firebaseDb, "barang", barangId), dataBarang);
            } else {
                saveDoc = window.firebaseUtils.addDoc(window.firebaseUtils.collection(window.firebaseDb, "barang"), dataBarang);
            }

            return saveDoc;
        })
        .then(function() {
            alert(barangId ? "Barang berhasil diperbarui!" : "Barang baru berhasil ditambahkan!");
            closeBarangModal();
            loadBarangData(); 
        })
        .catch(function(error) {
            console.error("Gagal menyimpan barang:", error);
            alert("Gagal menyimpan data barang. Pastikan semua field terisi benar dan coba lagi. Cek console log.");
        });
    });

    // FUNGSI NAVIGASI LOGIN/REGISTER
    window.showRegisterForm = function() {
        document.getElementById('loginFormContainer').classList.add('hidden');
        document.getElementById('registerFormContainer').classList.remove('hidden');
        document.getElementById('loginError').classList.add('hidden');
    }

    window.showLoginForm = function() {
        document.getElementById('registerFormContainer').classList.add('hidden');
        document.getElementById('loginFormContainer').classList.remove('hidden');
        document.getElementById('registerSuccess').classList.add('hidden');
    }
});
</script>
</body> 
</html>